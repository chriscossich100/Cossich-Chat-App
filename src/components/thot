import React, { useState, useEffect, useRef } from "react";
import { useParams, useNavigate } from "react-router-dom";
import styles from "./ChatRoom.module.css";

//this is the component that will get the current chat room and load the messages found in this chat room:
function ChatRoom() {
  //set the specific slug from the params using useParams:
  const { slug } = useParams();
  //set state to load all the messages in the chat room and a loading state while the messages load.
  const [messagesInTheChat, getMessages] = useState({
    loading: true,
    chatMessages: [],
    yourMessage: "",
  });

  let messageListEndRef = useRef(false);

  const formreset = useRef(null);

  function scrollToBottom() {
    if (messageListEndRef.current != false) {
      console.log("jdfkla;fjakl;jdfk;ajfdl;ajdkf;ajdkf;ajkdfal");
      return messageListEndRef.current?.scrollIntoView();
    }
  }

  console.log(
    "the messages in the chat line 10: ",
    messagesInTheChat.chatMessages,
    messagesInTheChat.loading
  );
  let messages = [];
  const navigate = useNavigate();
  console.log("this is me from the very beggining in the chat chatroom file");

  async function retrieveMessages() {
    console.log("function ran inside the setInterval");
    try {
      let header = {
        headers: {
          Authorization: "Token " + localStorage.getItem("auth-token"),
        },
      };
      const response = await fetch(
        `http://localhost:8001/gettingmessages/${slug}/`,
        header
      );
      const theResult = await response.json();
      console.log("the real result before anything is: ", theResult);

      //return the user back to the list of chat rooms if the chat room cant be found (if user manually types in the chat room in the url):
      if (theResult.NoRoomFound) {
        navigate("/home/chatrooms");
      } else {
        console.log("the result of the result is: ", theResult.MessagesInChatRoom);

        let lastOne = false;

        if (theResult.MessagesInChatRoom.length > messagesInTheChat.chatMessages.length) {
          console.log(
            "the theResult chats length is greater than: messagesInChatState"
          );
          messageListEndRef.current = true;
        } else {
          console.log("apparently its smaller???");
          messageListEndRef.current = false;
        }
        messages = theResult.MessagesInChatRoom.map((x) => {

          //get the time of the message and adjust it to the proper time:
          let xTime = new Date(x.dateCreated)
          console.log(xTime.getHours())
          
          if (!theResult.MessagesInChatRoom[x + 1]) {
            lastOne = true;
          }

          return (
            <div
              className={
                theResult.currentUser == x.author
                  ? styles.chatMessagesContainerMessage
                  : styles.chatMessageContainerMessageNotCurrentUser
              }
              ref={lastOne == false ? null : messageListEndRef}
            >
              <span></span>
              <div className={styles.chatMessagesContainerMessageDetail}>
                <div
                  className={
                    theResult.currentUser == x.author
                      ? styles.chatMessageContainerMessageDetailDiv
                      : styles.chatMessageContainerMessageDetailDivNotCurrentUser
                  }
                >
                  <div>
                    <div
                      className={
                        styles.chatMessageContainerMessageDetailDivContent
                      }
                    >
                      <div className={styles.chatStructure}>
                        <span className={styles.chatStructureSpan}>
                          {x.message}
                        </span>
                        <span className={styles.chatStructureSpan2}>
                          <span
                            className={styles.chatStructureSpan2TimeStructure}
                          >
                            <span className={styles.chatStructureSpan2TimeSpec}>
                              <span className={styles.chat2Time}>{xTime.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</span>
                            </span>
                          </span>
                        </span>
                      </div>
                      <div
                        style={{
                          marginLeft: "4px",
                          marginRight: "0",
                          zIndex: "10",
                          position: "relative",
                          float: "right",
                          marginBottom: "-5px",
                          marginTop: "-10px",
                        }}
                      >
                        <div
                          style={{
                            cursor: "pointer",
                            display: "flex",
                            fontSize: ".6875rem",
                            whiteSpace: "normal",
                            whiteSpace: "nowrap",
                            color: "#66781",
                            alignItems: "center",
                            height: "15px",
                            lineHeight: "15px",
                          }}
                        >
                          <span
                            style={{
                              display: "inline-block",
                              verticalAlign: "top",
                            }}
                          >
                            {xTime.toLocaleTimeString([], { hour: 'numeric', minute: "2-digit" })}
                          </span>
                        </div>
                      </div>
                    </div>
                    <div></div>
                  </div>
                </div>
              </div>
              <span style={{ fontSize: "11px" }}>{x.author}</span>
            </div>
          );
        });

        //this if check will update the state if the messages list contains at least one message:
        //if not don't update the state and just do the intial render
        if (messages.length > 0) {
          console.log(messages);

          getMessages({ loading: false, chatMessages: messages });
        } else {
          getMessages({ loading: false, chatMessages: [] });
        }
      }
    } catch (err) {
      console.error("the error that occured is: ", err);
    }

    //this initially checks if the state has any messages. If it doesn't run the function
    //keep in mind thaat once the function runs, and it does find messages, the state will update, meaining it will re-render
    //this if statement will run again, but this time since there is are messages, it doesnt run the function. This prevents an infinite loop
    // if (messagesInTheChat.length == 0) {
    //   console.log(
    //     "the length of messages in the chat is: ",
    //     messagesInTheChat.length
    //   );
    //   retrieveMessages();
    // }
    return messages;
  }

  //we're going to use a useeffect so that we can load the messages and also reload/re-render them every second.
  useEffect(() => {
    console.log(
      "the length of the messages is, ",
      messagesInTheChat.chatMessages.length
    );
    console.log(
      "im assuming this ran after the render like it's supposed to",
      messageListEndRef.current
    );

    const interval = setInterval(async () => {
      console.log("this is the time interval");
      retrieveMessages();
    }, 1000);

    if (messageListEndRef.current != false) {
      console.log("do we get here?");
      scrollToBottom();
    }
    return () => clearInterval(interval);
  }, [messagesInTheChat.chatMessages]);

  async function sendMessage(e) {
    e.preventDefault();
    let formData = e.target;
    let messageInfo = new FormData();
    messageInfo.append("message", formData["message"].value);
    messageInfo.append("author", localStorage.getItem("auth-token"));
    console.log("e is : ", e.target["message"].value);
    console.log("the slug is: ", slug);
    console.log("the form data is: ", messageInfo);
    try {
      let header = {
        method: "POST",
        headers: {
          Authorization: "Token " + localStorage.getItem("auth-token"),
        },
        body: messageInfo,
      };
      const response = await fetch(
        `http://localhost:8001/createmessages/${slug}/`,
        header
      );
      const result = await response.json();
      console.log("the result is: ", result);
    } catch (err) {
      console.error(err);
    }
    formreset.current.value = "";
  }

  console.log("test to seee if this runs before the useeffect");

  if (
    messagesInTheChat.chatMessages.length == 0 &&
    messagesInTheChat.loading == true
  ) {
    console.log(
      "are we reaching this part of the code wheere the user is just saying some bullshit for no reason "
    );
    retrieveMessages();
  }

  return (
    <main className={styles.mainChatMain}>
      <div className={styles.mainChatMainDiv}>
        <div className={styles.mainChatMainDivContainer}>
          <div
            style={{ height: "100%", position: "absolute", width: "100%" }}
          ></div>
          <main className={styles.chatMainWrapper}>
            <div style={{ visibility: "visible" }}>
              <div className={styles.chatMainWrapperContent}>
                <div style={{ flex: "1 1 auto", minHeight: "12px" }}></div>
                <div className={styles.chatMainDiv}>
                  <div style={{ width: "100%" }}>
                    <div className={styles.chatMessagesContainerMessageFirstMessage}>
                      <span></span>
                      <div
                        className={styles.chatMessagesContainerMessageDetail}
                      >
                        <div
                          className={
                            styles.chatMessageContainerMessageDetailDivFirstMessage
                          }
                        >
                          <div>
                            <div
                              className={
                                styles.chatMessageContainerMessageDetailDivContent
                              }
                            >
                              <div className={styles.chatStructure}>
                                <span className={styles.chatStructureSpan}>
                                  Bienvenidos a este cuarto de chat. No se
                                  permite el acoso o mensajes que promueven la
                                  violencia. Si a caso se encuentra mensajes que
                                  van en contra estas reglas la cuenta a la que
                                  los mensajes pertenecen será prohibido.
                                </span>
                              </div>
                            </div>
                            <div></div>
                          </div>
                        </div>
                      </div>
                    </div>
                    {messagesInTheChat.chatMessages}
                  </div>
                </div>
              </div>
            </div>
          </main>
          <form className={styles.chatMainForm} onSubmit={sendMessage}>
            <input
              type="text"
              ref={formreset}
              placeholder="Enviar Mensaje"
              name="message"
              maxLength="950"
            ></input>
            <button style={{ display: "none" }} type="submit">
              Submit your message
            </button>
          </form>
        </div>
      </div>
    </main>
  );
}

export default ChatRoom;
